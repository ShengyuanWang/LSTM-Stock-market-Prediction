---
title: "ARIMA"
author: "MCM2022"
date: "2/19/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(tseries)
library(forecast)

theme_set(theme_minimal())

set.seed(123)
```

```{r}
# Load the data & clean the data
bitcoin_data <- read.csv("data/BCHAIN-MKPRU.csv") %>% 
  mutate(Date = as.Date(Date, "%m/%d/%y")) %>% 
  na.omit()

gold_data <- read.csv("data/LBMA-GOLD.csv") %>% 
  mutate(Date = as.Date(Date, "%m/%d/%y")) %>% 
  na.omit()
```

```{r}
dataset = bitcoin_data$Value
train_size <- as.integer(length(dataset) * 0.8)
test_size <- length(dataset) - train_size
train <- dataset[1:train_size]
test <- dataset[(train_size + 1):length(dataset)]

bitcoin_new <- bitcoin_data %>% 
  mutate(Type = ifelse(Date < "2020-09-09", "train", "test"))
```

```{r}
fitARIMA <- auto.arima(train, trace = FALSE)
predARIMA <- forecast(fitARIMA, h = 366, level = c(99))
validation <- as.numeric(predARIMA$mean)

bitcoin_validation <- bitcoin_new %>% 
  filter(Date > "2020-09-09") %>% 
  mutate(Value = validation,
         Type = "validation")

bitcoin_arima <- bitcoin_new %>% 
  rbind(bitcoin_validation)

bitcoin_arima %>% 
  ggplot(aes(x = Date, 
             y = Value, 
             color = Type)) +
  geom_line()

normal_val <- validation
```

```{r}
fitARIMA <- auto.arima(log(train), trace = FALSE)
predARIMA <- forecast(fitARIMA, h = 366, level = c(99))
validation <- as.numeric(predARIMA$mean)

bitcoin_validation <- bitcoin_new %>% 
  filter(Date > "2020-09-09") %>% 
  mutate(Value = exp(validation),
         Type = "validation")

bitcoin_arima <- bitcoin_new %>% 
  rbind(bitcoin_validation)

bitcoin_arima %>% 
  ggplot(aes(x = Date, 
             y = Value, 
             color = Type)) +
  geom_line()

log_val <- exp(validation)
```

```{r}
fitARIMA <- auto.arima(diff(log(train)), trace = FALSE)
predARIMA <- forecast(fitARIMA, h = 366, level = c(99))
validation_dif <- as.numeric(predARIMA$mean)

validation <- c()
preNum <- train[length(train):length(train)]

for (i in 1:length(validation_dif))
{
  nextInput <- exp(validation_dif[i:i])*preNum
  validation <- c(validation, nextInput)
  preNum <- nextInput
}

bitcoin_validation <- bitcoin_new %>% 
  filter(Date > "2020-09-09") %>% 
  mutate(Value = validation,
         Type = "validation")

bitcoin_arima <- bitcoin_new %>% 
  rbind(bitcoin_validation)

bitcoin_arima %>% 
  ggplot(aes(x = Date, 
             y = Value, 
             color = Type)) +
  geom_line()

diff_log_val <- validation
```

```{r}
head(normal_val)
head(log_val)
head(diff_log_val)
```

```{r}
value <- bitcoin_data$Value[1:5]

model_arima <- function(result, listIn)
{
  temp = result
  for (i in 5:length(listIn))
  {
    train_data <- listIn[1:i]
    fitARIMA <- auto.arima(diff(log(train_data)), trace = FALSE)
    predARIMA <- forecast(fitARIMA, h = 1, level = c(99))
    pred <- as.numeric(predARIMA$mean)
    new_value <- 2 ^ pred * listIn[i:i]
    temp = c(temp, new_value)
    print(i+1)
    print(new_value)
  }
  return(temp)
}

value <- model_arima(value, bitcoin_data$Value)
value <- value[1:length(value) - 1]
```

```{r}
bitcoin_result <- bitcoin_data %>% 
  cbind(value)

ggplot(data = bitcoin_result) +
  geom_line(mapping = aes(x = Date,
                          y = Value,
                          color = "red")) +
  geom_line(mapping = aes(x = Date,
                          y = value,
                          color = "blue")) +
  theme_minimal()

bitcoin_result
```

```{r}
bitcoin_test <- bitcoin_result %>% 
  filter(Date >= "2017-11-20",
         Date <= "2017-12-20")

ggplot(data = bitcoin_test) +
  geom_line(mapping = aes(x = Date,
                          y = Value,
                          color = "red")) +
  geom_line(mapping = aes(x = Date,
                          y = value,
                          color = "blue")) +
  theme_minimal()

bitcoin_result %>% 
  mutate(dif = abs(Value - value))
```

```{r}
bitcoin_final <- bitcoin_result %>% 
  filter(Date > "2016-09-15") %>% 
  select(Date, value)

write.csv(bitcoin_final, "prediction/bitcoin_ARIMA_result.csv", row.names = FALSE)
```


